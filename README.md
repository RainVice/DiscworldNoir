# Unity ä¸€å­¦æœŸ æœŸæœ«å¤§ä½œä¸š

![Untitled](image/Untitled.png)

![Untitled](image/Untitled%201.png)

![Untitled](image/Untitled%202.png)

# ä¸€ã€ä»‹ç»

**æ— å°½é»‘å¤œï¼š**

ä¸€ä¸ªç»è¥ç±»çš„å¡”é˜²2Dæ¸¸æˆï¼Œéœ€è¦ç©å®¶æ”¾ç½®ä¸åŒçš„ç‰©å“æ¥åˆ©ç”¨åœºæ™¯ä¸­çš„èµ„æºæ¥æ‰“é€ è‡ªå·±çš„æ‘åº„ã€‚

âš ï¸ï¼šæ¯éš”30ç§’ä¼šæœ‰å¤œå¹•é™ä¸´ï¼Œåœ¨é»‘å¤œä¹‹ä¸­ï¼Œä¼šæœ‰å¹½çµğŸ‘»æ¥è¿›æ”»ä½ çš„å¤§æœ¬è¥ï¼Œä¸”å¹½çµä¼šè¶Šæ¥è¶Šå¼ºï¼Œä½ è¦åšçš„å°±æ˜¯ä¿æŠ¤æ‘åº„ï¼Œåº¦è¿‡ä¸€ä¸ªä¸ªé»‘å¤œã€‚

**å†…å®¹ä»‹ç»ï¼š**

æœ¬æ¸¸æˆè®¾ç½®åç§å»ºç­‘ï¼Œä¸‰ç§è‡ªç„¶èµ„æºä¸åœ°å½¢ï¼Œè¿˜æœ‰ä¸€ç§äººé€ èµ„æºï¼Œä»¥åŠæ•Œäººå¹½çµã€‚

1. ä¸‰ç§è‡ªç„¶èµ„æºï¼ˆåœ°å½¢ï¼‰ï¼š
    1. **æ°´æ™¶ï¼ˆæ°´æ™¶çŸ¿ï¼‰**ï¼šæ¸¸æˆä¸­çš„è´§å¸ï¼Œéœ€è¦é€šè¿‡æŒ–æ˜æ°´æ™¶çŸ¿æ‰èƒ½è·å¾—ã€‚
    2. **æœ¨æï¼ˆæ£®æ—ï¼‰**ï¼šææ–™ï¼Œç”¨äºå’Œé“é”­åˆæˆå­å¼¹ã€‚
    3. **é“ï¼ˆé“çŸ¿ï¼‰**ï¼šææ–™ï¼Œç”¨äºå’Œæœ¨æä¸€èµ·åˆæˆä¸ºå­å¼¹ã€‚
2. äººé€ èµ„æºï¼š
    1. **å­å¼¹**ï¼Œä½¿ç”¨æœ¨æå’Œé“é”­åˆæˆï¼Œä¾›ç»™ç»™å¤§æœ¬è¥å’Œç‚®å°
3. åç§å»ºç­‘ï¼š
    1. **å¤§æœ¬è¥**ï¼šä¸»è¦å»ºç­‘ï¼Œå‚¨å­˜æ°´æ™¶ï¼Œå…·æœ‰æ”»å‡»èƒ½åŠ›ï¼Œéœ€è¦å­å¼¹å·¥å‚ä¸ºå…¶ä¾›åº”å­å¼¹
    2. **åŸå¢™**ï¼šè¡€é‡è¾ƒå¤šï¼Œç”¨äºæŠµå¾¡å¹½çµçš„è¿›æ”»
    3. **ç‚®å°**ï¼šæ”»å‡»å¹½çµï¼Œéœ€è¦å­å¼¹å·¥å‚ä¸ºå…¶ä¾›åº”å­å¼¹ï¼Œåªèƒ½æ”¾ç½®åœ¨å­å¼¹åŠ å·¥å‚æˆ–è€…è¿è¾“å™¨é™„è¿‘
    4. **é‡‡çŸ¿æœºï¼ˆé“ï¼‰**ï¼šé‡‡é›†é“çŸ¿ï¼Œè¿è¾“ç»™åŠ å·¥å‚ï¼ˆé“çŸ¿ï¼‰åŠ å·¥æˆé“é”­ï¼Œåªèƒ½æ”¾ç½®åœ¨é“çŸ¿é™„è¿‘
    5. **æ°´æ™¶é‡‡é›†å™¨**ï¼šé‡‡é›†æ°´æ™¶ï¼Œä½œä¸ºé€šç”¨è´§å¸ä½¿ç”¨ï¼Œç›´æ¥ä¾›åº”ç»™å¤§æœ¬è¥ï¼Œåªèƒ½æ”¾ç½®åœ¨æ°´æ™¶çŸ¿é™„è¿‘
    6. **å­å¼¹åŠ å·¥å‚**ï¼šéœ€è¦æœ¨æå’Œé“é”­æ‰èƒ½åˆ¶é€ å­å¼¹ï¼Œåªèƒ½æ”¾ç½®åœ¨åŠ å·¥å‚ï¼ˆæœ¨æï¼‰å’ŒåŠ å·¥å‚ï¼ˆé“ï¼‰æˆ–è€…è¿è¾“å™¨é™„è¿‘
    7. **è¿è¾“å™¨**ï¼šå¯ä»¥è¿è¾“é™¤æœªå¤„ç†çš„æœ¨æå’Œé“çŸ¿ä¹‹å¤–çš„ä»»ä½•ä¸œè¥¿
    8. **ä¼æœ¨æœº**ï¼šç ä¼æ ‘æœ¨ï¼Œè¿è¾“ç»™åŠ å·¥å‚ï¼ˆæœ¨æï¼‰åŠ å·¥ï¼Œåªèƒ½æ”¾ç½®åœ¨æ£®æ—é™„è¿‘
    9. **åŠ å·¥å‚ï¼ˆæœ¨æï¼‰**ï¼šé€šè¿‡ä¼æœ¨æœºé€æ¥çš„æ ‘æœ¨åŠ å·¥æˆæœ¨æï¼Œåªèƒ½æ”¾ç½®åœ¨ä¼æœ¨æœºæˆ–è€…è¿è¾“å™¨é™„è¿‘
    10. **åŠ å·¥å‚ï¼ˆé“ï¼‰**ï¼šé€šè¿‡é‡‡çŸ¿æœºï¼ˆé“ï¼‰è¿è¾“æ¥çš„é“çŸ¿çŸ³åŠ å·¥æˆé“é”­ï¼Œåªèƒ½æ”¾ç½®åœ¨é‡‡çŸ¿æœºï¼ˆé“ï¼‰é™„è¿‘ã€‚
4. **å¹½çµ**ï¼Œä¼šä¸é¡¾ä¸€åˆ‡çš„å†²å‘å¤§æœ¬è¥ï¼Œå¹¶æ‘§æ¯è·¯é€”ä¸­çš„å»ºç­‘

# äºŒã€å®ç°

ä¸»è¦ç±»å…³ç³»å›¾

![Untitled](image/Untitled%203.png)

## 1ã€æ­å»ºUI

â€¦..

é€šè¿‡ç‚¹å‡»é€‰æ‹©å»ºç­‘ï¼Œåœ¨åœ°å›¾ä¸Šåˆ›å»ºã€‚é€šè¿‡äº†ä¸€ä¸ªGameManageræ¥äº¤æ¢æ•°æ®ã€‚

## 2ã€åœ°å›¾åŠŸèƒ½

### (1)é€‰æ‹©æ”¾ç½®

é€‰æ‹©äº†èœ‚çªçŠ¶çš„ç½‘æ ¼åœ°å›¾ï¼Œç½‘æ ¼åœ°å›¾æœ‰ä¸€ä¸ªä¼˜ç‚¹ï¼Œå¯ä»¥ç›´æ¥è·å–æˆ‘çš„é¼ æ ‡åœ¨é‚£ä¸ªç½‘æ ¼ä¸Šï¼Œæ–¹ä¾¿æ”¾ç½®å»ºç­‘ã€‚è‡³äºä¸ºä½•é€‰æ‹©**èœ‚çªçŠ¶**çš„ï¼Œçº¯å±è„‘æŠ½ï¼ˆè®°ä½èœ‚çªåœ°å›¾ï¼Œåé¢è¦è€ƒçš„ï¼‰ã€‚

é€šè¿‡æŸ¥é˜…èµ„æ–™ï¼Œæš‚æ—¶æ²¡æœ‰æ‰¾åˆ°é¼ æ ‡ç§»å…¥ç§»å‡ºç½‘æ ¼çš„äº‹ä»¶ï¼Œé€šè¿‡è‡ªå·±å®ç°ç›‘å¬ä¸Šä¸€æ¬¡é¼ æ ‡æ»‘åŠ¨çš„ä½ç½®æ¥æ¯”è¾ƒæ˜¯å¦ç§»å…¥ç§»å‡ºç½‘æ ¼ã€‚

```csharp
/// <summary>
/// é¼ æ ‡åœ¨ç“¦ç‰‡ä¸Šäº‹ä»¶
/// </summary>
private void OnMouseToTileListener()
{
    // è·å–åæ ‡
    var mousePos = m_Camera.ScreenToWorldPoint(Input.mousePosition);
    var cellPos = m_Tilemap.WorldToCell(mousePos);
    // å¦‚æœåæ ‡æ”¹å˜ï¼Œåˆ™è§¦å‘äº‹ä»¶
    if (m_PreVector3Int != cellPos && m_Tilemap.HasTile(cellPos))
    {
        m_CurVector3Int = cellPos;
        OnMouseExitTile(m_PreVector3Int);
        OnMouseEnterTile(cellPos);
        m_PreVector3Int = cellPos;
    }
}
/// <summary>
/// é¼ æ ‡æ»‘å…¥ç“¦ç‰‡äº‹ä»¶
/// </summary>
/// <param name="cellPos">ç“¦ç‰‡çš„åæ ‡</param>
private void OnMouseEnterTile(Vector3Int cellPos) { }

/// <summary>
/// é¼ æ ‡æ»‘å‡ºç“¦ç‰‡çš„äº‹ä»¶
/// </summary>
/// <param name="cellPos">ç“¦ç‰‡çš„åæ ‡</param>
private static void OnMouseExitTile(Vector3Int cellPos) { }
```

å½“æ»‘åŠ¨åˆ°ä¸åŒçš„ç½‘æ ¼æ—¶ï¼Œé€‰ä¸­çš„ç‰©ä½“è·Ÿéšé¼ æ ‡åˆ‡æ¢åˆ°ä¸åŒçš„ç½‘æ ¼ä¸­ã€‚é€šè¿‡å·¦é”®ç‚¹å‡»æ”¾ç½®ï¼Œå³é”®ç‚¹å‡»å–æ¶ˆæ”¾ç½®ï¼ˆåŠŸèƒ½è¿‡äºç®€å•ä¸è¿‡å¤šè®²è§£ï¼‰

æ”¾ç½®å»ºç­‘ä»¥åï¼Œéœ€è¦å°†å…¶ä¿å­˜åˆ° GameManager ä¸­å¤‡ç”¨ï¼Œå…·ä½“å®ç°åœ¨ä¸‹æ–‡ã€‚

### (2)åœ°å›¾å˜åŒ–åŠŸèƒ½

é€šè¿‡ç›‘å¬é¼ æ ‡æŒ‰ä¸‹è·å–ä½ç½®åç§»æ¥æ”¹å˜æ‘„åƒå¤´ä½ç½®ã€‚é€šè¿‡é¼ æ ‡æ»šè½®ç›‘å¬æ¥æ”¹å˜æ‘„åƒå¤´çš„è§‚æµ‹å¤§å°ã€‚

## 3ã€æ”¾ç½®åŠŸèƒ½

### (1)æ‰«æ

éœ€è¦å®ç°å®Œæ•´çš„æ”¾ç½®åŠŸèƒ½ï¼Œé¦–å…ˆéœ€è¦å®ç°å„ä¸ªå»ºç­‘çš„æ§åˆ¶ç±»ï¼Œåªæœ‰ä»¥åˆ¤æ–­æ˜¯å¦ä¸å¯¹åº”çš„å»ºç­‘å»ºç«‹çº¿è·¯ã€‚è¿™é‡Œå…ˆå‡è®¾å»ºç­‘å¯ä»¥ä¸æ‰€æœ‰ç‰©ä½“å»ºç«‹è”ç³»ã€‚

é¦–å…ˆï¼Œéœ€è¦å»ºç«‹è”ç³»ï¼Œæˆ‘ä»¬å°±éœ€è¦ä¸€ä¸ªèŒƒå›´ï¼ˆnï¼‰ï¼Œå¯ä»¥å®šä¹‰åœ¨å»ºç­‘ç±»ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æ‰«æå‘¨å›´ n åœˆæ¥åˆ¤æ–­æ˜¯å¦æœ‰ç‰©ä½“ï¼Œæœ‰ç‰©ä½“åˆ™è¿æ¥ã€‚

è¿™æ—¶å°±å‡ºç°äº†ä¸€ä¸ªæå…¶æ£˜æ‰‹çš„é—®é¢˜ï¼Œåœ¨æ­£å¸¸çš„å››è¾¹å½¢åæ ‡ç³»ä¸­ï¼Œæ¨ªçºµåæ ‡éƒ½æ˜¯ç›´çº¿ï¼Œè€Œåœ¨èœ‚çªåœ°å›¾ä¸­ï¼Œåæ ‡ç³»å°±æ¯”è¾ƒæŠ½è±¡äº†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![Untitled](image/Untitled%204.png)

è€Œæˆ‘éœ€è¦æ‰«æçš„æ˜¯ç»¿åœˆä»¥åŠå‘å¤–çš„èŒƒå›´ã€‚å¹¶ä¸èƒ½é€šè¿‡åŸæœ‰çš„åæ ‡ç³»å¾ˆå¥½çš„è®¡ç®—å‘¨å›´çš„æ•°å€¼ã€‚

è¿™é‡Œä¹Ÿå°±æ˜¯ä¸Šæ–‡è¯´çš„é€‰èœ‚çªåœ°å›¾çš„é—®é¢˜ã€‚

è¿™é‡Œæˆ‘æƒ³å‡ºäº†ä¸€ä¸ªè§£å†³æ–¹æ¡ˆï¼Œé€šè¿‡å‚è€ƒæ•°å­¦ä¸Šçš„ä¸‰è§’å‡½æ•°ï¼Œè®¾è®¡äº†ä¸€ä¸ªç±»ä¼¼äºå‘é‡çš„åæ ‡ç³»ï¼š

ï¼ˆå±‚æ•°ï¼Œç´¢å¼•ï¼‰

ä»åŸç‚¹åæ ‡å¼€å§‹ï¼Œä»–çš„å€¼æ˜¯ï¼ˆ0ï¼Œ0ï¼‰ï¼Œç¬¬ä¸€åœˆçš„å€¼æ˜¯ï¼ˆ1,0~5ï¼‰å…¶ä¸­ç´¢å¼•çš„èŒƒå›´æ˜¯å¯ä»¥é€šè¿‡å±‚æ•°è®¡ç®—å¾—å‡º ç´¢å¼•æœ€å¤§å€¼ = (å±‚æ•° * 2 - 1) * 6ã€‚ç”±æ­¤åªéœ€è¦çŸ¥é“å±‚æ•°ï¼Œå°±å¯ä»¥è®¡ç®—å‡ºè¿™ä¸ªèŒƒå›´çš„ç‰©ä½“ã€‚

å…·ä½“å®ç°ï¼š

é¦–å…ˆéœ€è¦æŠŠ`Grid` ç»„ä»¶çš„`CellSize` çš„ XY æ¯”ä¸º 1 : (2 / 3 * âˆš3)ï¼Œå°æ•° 1:1.212435565298214

```csharp
using System;
using UnityEngine;
/// <summary>
/// è‡ªå®šä¹‰åæ ‡ç³»ç»Ÿ
/// </summary>
public struct LayerPosition
{
    private static float Length = 1f;// è¿™é‡Œå†™Xçš„å€¼
    public int layer;
    public int position;
    public LayerPosition(int layer, int position = 0)
    {
        this.layer = layer;
        this.position = position;
    }
    /// <summary>
    /// è§’åº¦
    /// </summary>
    public float Angle
    {
        get
        {
            if (layer == 0) return 0;
            return 360f / layer / 6f * position;
        }
    }
    /// <summary>
    /// è·ç¦»
    /// </summary>
    public float Distance => layer * Length;
    /// <summary>
    /// æ­¤å±‚ä¸ªæ•°
    /// </summary>
    public int Count
    {
        get
        {
            if (layer == 0) return 1;
            return layer * 6;
        }
    }
    /// <summary>
    /// è®¡ç®— Vertor3
    /// </summary>
    /// <returns></returns>
    public Vector3 GetVector3()
    {
        return new Vector3(
            Distance * Mathf.Cos(Angle * Mathf.Deg2Rad),
            Distance * Mathf.Sin(Angle * Mathf.Deg2Rad),
            0
        );
    }
    /// <summary>
    /// æ‰«æå‘¨å›´çš„åœ°å½¢
    /// </summary>
    /// <param name="curVector3">å½“å‰çš„åæ ‡</param>
    /// <param name="action">åæ ‡å¤„ç†å›è°ƒ</param>
    public void Scan(Vector3 curVector3, Action<Vector3> action)
    {
        for (var i = 1; i <= layer; i++)
        {
            for (var j = 1; j <= 6 * i; j++)
            {
                var vector3 = curVector3 + new LayerPosition(i, j);
                action.Invoke(vector3);
            }
        }
    }
    /// <summary>
    /// Vector3 è½¬ LayerPosition
    /// </summary>
    /// <param name="vector3"></param>
    /// <returns></returns>
    public static LayerPosition Vector3ToLayerPosition(Vector3 vector3)
    {
        var layer = Mathf.RoundToInt(vector3.magnitude / Length);
        // è®¡ç®—vertor3è§’åº¦
        var angle = Mathf.Atan2(vector3.y, vector3.x) * Mathf.Rad2Deg;
        if (angle < 0) angle += 360;
        var position = Mathf.RoundToInt(angle / (360f / layer / 6f));
        return new LayerPosition(layer, position);
    }
}
```

æ”¾ç½®ä¹‹å‰ä¼šåˆ¤æ–­æ˜¯å¦å¯ä»¥æ”¾ç½®ï¼Œä¸å¯æ”¾ç½®ä¼šæ˜¾ç¤ºçº¢è‰²ï¼Œåˆ¤æ–­é€»è¾‘åœ¨å„ä¸ªå»ºç­‘ä¸­ã€‚

åŒæ—¶ä¸å¯æ”¾ç½®åœ¨å·²æœ‰ç‰©ä½“çš„ç½‘æ ¼ä¸­ã€‚

### (2)è¿çº¿

é¦–å…ˆå®šä¹‰ä¸€ä¸ª`Line` ç±»æ§åˆ¶å„ä¸ªå»ºç­‘ä¹‹é—´çš„çš„è¿çº¿æ˜¾ç¤ºï¼Œä»¥æ–¹ä¾¿æ§åˆ¶å»ºç­‘ç§»åŠ¨å’Œé”€æ¯æ—¶æ”¹å˜è¿çº¿ï¼š

```csharp
using System;
using System.Collections.Generic;
using System.Linq;
using Effect;
using Unity.VisualScripting;
using UnityEngine;

/// <summary>
/// æ§åˆ¶çº¿æ®µçš„å¤§å°
/// </summary>
public class Line : MonoBehaviour
{
    public GameObject circle;
    private Vector2 StartPos { get; set; }
    private Vector2 EndPos { get; set; }
    private LayerPosition StartLayerPosition { get; set; }
    private LayerPosition EndLayerPosition { get; set; }
    private float Magnitude { get; set; }
    private float Angle { get; set; }
    private List<GameObject> m_circleList = new();
    private void Awake()
    {
        StartLayerPosition = LayerPosition.Vector3ToLayerPosition(StartPos);
        EndLayerPosition = LayerPosition.Vector3ToLayerPosition(EndPos);
    }
    /// <summary>
    /// æ¨é€èµ„æº
    /// </summary>
    /// <param name="direction">true: å‘å¤–æ¨é€, false: å‘å†…æ¨é€</param>
    /// <param name="onFinish">æ¨é€å®Œæˆå›è°ƒ</param>
    public void Push(bool direction, Action onFinish = null)
    {
        var start = StartPos;
        var end = EndPos;
        if (!direction)
        {
            start = EndPos;
            end = StartPos;
        }
        var instantiate = Instantiate(circle,start,Quaternion.identity);
        m_circleList.Add(instantiate);
        this.CreateEffect().AddEffect(instantiate.transform.SlideTFTo(start,end)).Play(() =>
        {
            onFinish?.Invoke();
            m_circleList.Remove(instantiate);
            Destroy(instantiate);
        });
    }
    /// <summary>
    /// ç”»çº¿
    /// </summary>
    /// <param name="startPos"></param>
    /// <param name="endPos"></param>
    /// <param name="color"></param>
    public static Line DrawLine(Vector2 startPos, Vector2 endPos)
    {
        // è®¡ç®—è§’åº¦å’Œè·ç¦»
        var offset = endPos - startPos;
        var magnitude = offset.magnitude;
        var angle = Mathf.Atan2(offset.y, offset.x) * Mathf.Rad2Deg;
        // è®¾ç½®é•¿åº¦å’Œè§’åº¦
        var instantiate = Instantiate(GameManager.Instance.LinePrefab, startPos, Quaternion.identity);
        var localScale = instantiate.transform.localScale;
        localScale.x = magnitude;
        instantiate.transform.localScale = localScale;
        var eulerAngles = instantiate.transform.eulerAngles;
        eulerAngles.z = angle;
        instantiate.transform.eulerAngles = eulerAngles;
        var component = instantiate.GetComponent<Line>();
        component.StartPos = startPos;
        component.EndPos = endPos;
        component.Magnitude = magnitude;
        component.Angle = angle;
        return component;
    }
    private void OnDestroy()
    {
        foreach (var o in m_circleList.Where(o => !o.IsDestroyed()))
        {
            Destroy(o);
        }
    }
}
```

å…¶ä¸­æä¾›äº†`DrawLine` çš„é™æ€æ–¹æ³•ç”¨äºç”»çº¿ã€‚

æ‰€æœ‰è¿çº¿çš„æ•°æ®éƒ½ä¿å­˜åœ¨GameMagagerä¸­çš„é‚»æ¥è¡¨ä¸­ï¼Œä»¥ä¾¿åç»­ä½¿ç”¨ã€‚

## 4ã€å»ºç­‘

æˆ‘å°†å»ºç­‘åˆ†ä¸ºäº”å¤§ç±»ï¼šæ”»å‡»ã€é˜²å¾¡ã€ç”Ÿäº§ã€è¿è¾“ã€åˆ¶é€ 

é¦–å…ˆæˆ‘ä»¬éœ€è¦æ‰€æœ‰å»ºç­‘çš„åŸºç±»ï¼š**`BaseBuild`**ï¼Œå…¶ä¸­ä¿å­˜ä¸€äº›é€šç”¨æ•°æ®ï¼Œå¦‚èŒƒå›´ã€ç­‰çº§ç­‰ï¼Œæ•°æ®ä¸­æ•°æ®åº“ä¸­è·å–ï¼Œå®ç°ä¸€äº›é€šç”¨æ–¹æ³•ï¼š

```csharp

/// <summary>
/// æ‰€æœ‰å»ºç­‘çš„åŸºç±»
/// </summary>
public abstract class BaseBuild : BaseObstacle
{
    // **************** å±æ€§ *****************
    // æ˜¯å¦æ”¾ç½®
    public bool IsPlace
    {
        get => isPlace;
        set => isPlace = value;
    }
    
    // ***************** å¼•ç”¨ ******************
    
    // è¡€æ¡
    public Slider slider;

    // ***************** å˜é‡ ******************
    // å»ºç­‘ä¸­æ–‡å
    protected string CName;
    // èŒƒå›´
    protected int distance;
    // ç­‰çº§
    protected int level;
    // æ˜¯å¦æ”¾ç½®
    protected bool isPlace = false;
    // ç±»å‹
    protected BuildType buildType;
    // ç”Ÿå‘½
    protected float hp;
    // æœ€å¤§ç”Ÿå‘½
    protected int maxHp;
    // å‡çº§ä»·æ ¼
    protected int upgradePrice;
    // ä»·æ ¼
    protected int price;
    // è¿è¾“é€Ÿåº¦
    protected float waySpeed;
    // è¿è¾“è®¡æ—¶
    private float m_wayTimer;
    protected SpriteRenderer spriteRenderer;
    // è¿æ¥çš„éšœç¢
    protected Dictionary<Type, List<BaseObstacle>> obstacles = new();
    // åº“å­˜ç‰©èµ„
    protected Dictionary<Resource, int> inventory = new();
    // æ•°æ®
    protected BuildData m_buildData;
    // æœªæ”¾ç½®çŠ¶æ€çš„ä¸Šä¸€æ­¥ä½ç½®
    protected Vector3 m_lastPos;
    // çº¿æ¡é›†åˆ
    protected Dictionary<BaseObstacle,Line> m_lineDic = new();
    protected virtual void OnDestroy()
    {
        // é”€æ¯ä¸Šä¸€æ¬¡èµ„æº
        DestroyPre();
        GameManager.Instance.RemoveNode(this);
    }

    protected virtual void FixedUpdate()
    {
        // è°ƒç”¨ç§»åŠ¨äº‹ä»¶
        OnMove();
        // åˆ¤æ–­æ˜¯å¦å¯ä»¥è°ƒç”¨è¿è¾“äº‹ä»¶
        if (waySpeed!= 0 && isPlace)
        {
            m_wayTimer += Time.fixedDeltaTime;
            if (m_wayTimer >= Constant.DEFAULTTIME / waySpeed)
            {
                m_wayTimer %= Constant.DEFAULTTIME / waySpeed;
                OnWay();
            }
        }
    
    private void OnCollisionStay2D(Collision2D collision)
    {
        // æ¥è§¦åˆ°æ•Œäººæ‰£è¡€
        if (collision.gameObject.CompareTag("Enemy"))
        {
            hp -= Time.fixedDeltaTime * 5f;
            slider.gameObject.SetActive(true);
            // è¡€æ¡æ˜¾ç¤º
            slider.value = hp / maxHp;
        }
        if (hp <= 0)
        {
            Destroy(gameObject);
        }
    }

    private void OnCollisionExit2D(Collision2D other)
    {
        // æ•Œäººç¦»å¼€éšè—è¡€æ¡
        if (other.gameObject.CompareTag("Enemy"))
        {
            slider.gameObject.SetActive(false);
        }
    
    /// <summary>
    /// å±•ç¤ºå»ºç­‘ä¿¡æ¯
    /// </summary>
    public virtual void ShowInfo() { }
    /// <summary>
    /// è¿è¾“äº‹ä»¶
    /// </summary>
    protected virtual void OnWay() { }
    /// <summary>
    /// ç§»åŠ¨äº‹ä»¶
    /// </summary>
    protected virtual void OnMove()
    {
        if (m_lastPos == transform.position) return;
        m_lastPos = transform.position;
        // æ‰«æ
        Scan();
        // åˆ¤æ–­æ˜¯å¦å¯ä»¥æ”¾ç½®
        if (CanPlace())
        {
            var color = Color.white;
            color.a = 0.3f;
            GetComponent<SpriteRenderer>().color = color;
        }
        else
        {
            var color = Color.red;
            color.a = 0.3f;
            GetComponent<SpriteRenderer>().color = color;
        }

    }
    /// <summary>
    /// æ‰«æå‘¨å›´çš„æ ¼å­
    /// </summary>
    private void Scan()
    {        
        // é”€æ¯ä¸Šä¸€æ¬¡èµ„æº
        DestroyPre();
        OnScan(out var clean, out var action);
        clean?.Invoke();
        var layerPosition = new LayerPosition(distance);
        GameManager.Instance.Scan(layerPosition, transform.position, obstacle => action?.Invoke(obstacle));
    }
    /// <summary>
    /// æ‰«æå‘¨å›´çš„æ ¼å­
    /// </summary>
    /// <param name="clean">æ‰«æä¹‹å‰çš„æ¸…ç†</param>
    /// <param name="action">æ‰«æåç»“æœçš„å¤„ç†</param>
    protected virtual void OnScan(out Action clean, out Action<BaseObstacle> action)
    {
        clean = null;
        action = null;
    }
    /// <summary>
    /// æ·»åŠ çº¿
    /// </summary>
    /// <param name="end"></param>
    protected void AddLine(BaseObstacle end)
    {
        m_lineDic.Add(end,Line.DrawLine(transform.position, end.transform.position));
        if (!obstacles.ContainsKey(end.GetType()))
        {
            obstacles.Add(end.GetType(), new List<BaseObstacle>());
        }
        obstacles[end.GetType()].Add(end);
    }
    /// <summary>
    /// è·å–çº¿
    /// </summary>
    /// <param name="obs"></param>
    /// <returns></returns>
    public Line GetLine(BaseObstacle obs)
    {
        return m_lineDic[obs];
    }
    public Dictionary<BaseObstacle,Line> GetLines()
    {
        return m_lineDic;
    }
    /// <summary>
    /// é”€æ¯æ‰€æœ‰çº¿æ®µ
    /// </summary>
    protected void DestroyPre()
    {
        foreach (var line in m_lineDic.Where(line => !line.Value.IsDestroyed()))
        {
            Destroy(line.Value.gameObject);
        }
        m_lineDic.Clear();
        obstacles.Clear();
    }
    /// <summary>
    /// æ˜¯å¦å¯ä»¥æ”¾ç½®
    /// </summary>
    /// <returns></returns>
    public virtual bool CanPlace()
    {
        return GameManager.Instance.CrystalNum >= price;
    
    /// <summary>
    /// æ›´æ”¹èµ„æº
    /// </summary>
    /// <param name="type"></param>
    public virtual void ChangeNum(Resource resource,int num = 1)
    {
        inventory.TryAdd(resource, 0);
        inventory[resource] += num;
    
    public int GetNum(Resource resource)
    {
        return inventory.TryGetValue(resource, out var num) ? num : 0;
    }
    /// <summary>
    /// è¯¢é—®æ˜¯å¦æœ‰æŒ‡å®šç‰©è´¨
    /// </summary>
    /// <param name="resource"></param>
    /// <returns></returns>
    public virtual bool IsHave(Resource resource)
    {
        return false;
    }
    /// <summary>
    /// å‡çº§
    /// </summary>
    public virtual void Upgrade()
    {
        if (Constant.DEFAULTNUM * level > GameManager.Instance.CrystalNum)
        {
            UIManager.Instance.CreateToast("æ°´æ™¶ä¸è¶³ï¼Œæ— æ³•å‡çº§");
            return;
        }
        
        if (level >= 5)
        {
            UIManager.Instance.CreateToast("å·²ç»å‡çº§ä¸ºæœ€é«˜ç­‰çº§");
            return;
        }
        GameManager.Instance.CrystalNum -= Constant.DEFAULTNUM * level;
        level++;
        spriteRenderer.color = Constant.colors[level - 1];
    }
    /// <summary>
    /// ç§»é™¤
    /// </summary>
    public virtual void Remove()
    {
        Destroy(gameObject);
    }
}
```

ä»¥ä¸Šæ˜¯æ‰€æœ‰å»ºç­‘çš„é€šç”¨åŠŸèƒ½ï¼Œå…·ä½“éœ€è¦å­ç±»å®ç°ã€‚

### (1)æ”»å‡»ç±»å‹`BaseAttack`

å…¶ä¸­å®ç°äº†å¯¹æ”»å‡»è€…çš„ç›®æ ‡æ•Œäººæ·»åŠ ï¼Œè¿˜æœ‰æ”»å‡»æ•Œäººçš„æ–¹æ³•ã€‚

- å¤§æœ¬è¥ï¼šæ— ç‰¹æ®Šæ”»å‡»å®ç°
- åŠ å†œç‚®ï¼šæ— ç‰¹æ®Šæ”»å‡»å®ç°

### (2)é˜²å¾¡ç±»å‹`BaseDefense`

æš‚æ— ç‰¹æ®ŠåŠŸèƒ½ï¼Œåªèƒ½æŒ¨æ‰“

- åŸå¢™ï¼šæ— ç‰¹æ®ŠåŠŸèƒ½ï¼Œåªèƒ½æŒ¨æ‰“

### (3)åˆ¶é€ æœº`BaseMaker`

å®ç°äº†æ¯éš”ä¸€æ®µæ—¶é—´åˆ¶é€ èµ„æºï¼Œå…·ä½“åˆ¶é€ é€»è¾‘æä¾›æ¥å£ç”±å­ç±»å®ç°ã€‚

- åŠ å·¥å‚ï¼ˆæœ¨ï¼‰ï¼šé€šè¿‡è·å–ç”Ÿäº§è€…ä¼æœ¨æœºçš„èµ„æºï¼Œç”Ÿäº§æœ¨æã€‚
- åŠ å·¥å‚ï¼ˆé“ï¼‰ï¼šé€šè¿‡è·å–ç”Ÿäº§è€…é‡‡çŸ¿æœºï¼ˆé“ï¼‰æœºçš„èµ„æºï¼Œç”Ÿäº§é“é”­ã€‚
- å­å¼¹å·¥å‚ï¼šé€šè¿‡å‰ä¸¤è€…è·å–èµ„æºï¼Œç”Ÿäº§å­å¼¹

### (4)ç”Ÿäº§è€…`BaseProduce`

ç”¨äºé‡‡é›†åœ°å½¢ä¸­çš„æ•°æ®ï¼Œå®ç°æ¯éš”ä¸€æ®µæ—¶é—´è·å–ç‰©è´¨ï¼Œå…·ä½“è·å–å®ç°ç”±å­ç±»å®ç°ã€‚

- æ°´æ™¶é‡‡é›†å™¨ï¼šè·å–æ°´æ™¶åœ°å½¢
- ä¼æœ¨æœºï¼šè·å–æ ‘æœ¨
- é‡‡çŸ¿æœºï¼šè·å–é“çŸ¿

### (5)è¿è¾“å™¨`BaseWay`

æ— å…·ä½“å®ç°ï¼Œä½œä¸ºç‰©è´¨ä¼ é€çš„ä¸­è½¬ç«™ã€‚

- è¿è¾“çº¿è·¯ï¼šä½œä¸ºä¸­è½¬ç«™

å»ºç­‘ä¼šæ”¶åˆ°å¹½çµçš„æ”»å‡»ï¼Œè¡€é‡å‡ä¸º0é”€æ¯å»ºç­‘ã€‚å‡çº§å»ºç­‘å¯å°†è¡€æ¡æ‹‰æ»¡ã€‚

## 5ã€åœ°å½¢

åœ°å½¢æœ‰ä¸‰ç§ï¼Œåˆ†åˆ«ä¸ºæ£®æ—ï¼ˆ**`Tree`**ï¼‰ï¼Œé“ï¼ˆ**`Iron`**ï¼‰ï¼Œæ°´æ™¶ï¼ˆ**`Crystal`**ï¼‰

ä»–ä»¬æœ‰ä¸€ä¸ªåŸºç±»ï¼ŒåŸºç±»ä¸­å®šä¹‰äº†ä¸€ä¸ªæ–¹æ³•ï¼š

```csharp
/// <summary>
/// è¯¢é—®æ˜¯å¦éœ€è¦ä¼ å‡ºç‰©è´¨
/// </summary>
/// <returns></returns>
public virtual Resource IsOut()
{
    return Resource.None;
}
```

å­ç±»å®ç°æ–¹æ³•ï¼Œä¸åŒç‰©è´¨è¿”å›å‡ºçš„èµ„æºä¸ä¸€æ ·

## 6ã€æ•Œäºº

å°†å¤§æœ¬è¥ä½œä¸ºç›®æ ‡ï¼Œæ¯å¸§éƒ½å‘å…¶é è¿‘ä¸€ç‚¹ï¼Œå¹¶ä¸”å…·æœ‰è§¦å‘å™¨ç¢°æ’ä½“ï¼Œè§¦å‘åˆ°å¯æ”»å‡»å»ºç­‘æ—¶ï¼Œå‘æ”»å‡»å»ºç­‘ä¸­æ³¨å†Œè‡ªèº«ä¿¡æ¯ï¼Œä½¿æ”»å‡»å»ºç­‘å¯ä»¥æ”»å‡»åˆ°å¹½çµã€‚

## 7ã€åŠŸèƒ½

ä¸»è¦åŠŸèƒ½ï¼šæ•°æ®åº“ï¼ŒåŠ¨ç”»ï¼Œç‰©è´¨è¿è¾“

### (1)æ•°æ®åº“

å°è£…äº†ä¸€å¥—æ•°æ®åº“çš„æ’å…¥ä¸æŸ¥è¯¢æ–¹æ³•ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨ä»£ç ä¸­è°ƒç”¨å…¶æ¥å£å°±èƒ½æ ¹æ®ç±»æ¥åˆ›å»ºè¯»å–æ•°æ®åº“ã€‚

æˆ‘ä»¬ç”¨æ¥ä¿å­˜æ•°æ®çš„ç±»éœ€è¦ç»§æ‰¿`BaseData` æ¥ä¿è¯æ ¼å¼çš„æ­£ç¡®ï¼Œå…¶ä¸­å¯ä»¥æ‹¥æœ‰ä¸»é”®ï¼Œä¸»é”®ç”¨æ³¨è§£`PrimaryKey` è¡¨ç¤ºã€‚å¦‚ï¼š

```csharp
public class BuildData : BaseData
{
    // å»ºç­‘åç§°
    [PrimaryKey]
    public string buildName;
    // å»ºç­‘ä¸­æ–‡å
    public string name;
    // èŒƒå›´
    public int distance;
    // ç­‰çº§
    public int level;
    // æ˜¯å¦æ”¾ç½®
    public bool isPlace = false;
    // ç±»å‹
    public BuildType buildType;
    // ç”Ÿå‘½
    public int hp;
    // å‡çº§ä»·æ ¼
    public int upgradePrice;
    // ä»·æ ¼
    public int price;
    // æ”»å‡»åŠ›
    public int attack;
    // ç”Ÿäº§é€Ÿåº¦
    public int productionSpeed;
    // è¿è¾“é€Ÿåº¦
    public int waySpeed;
    // æè¿°
    public string description;
    
    public override string ToString()
    {
        return $"å»ºç­‘åç§°ï¼š{name} \nèŒƒå›´ï¼š{distance} \nç­‰çº§ï¼š{level} \næ˜¯å¦æ”¾ç½®ï¼š{isPlace} \nç±»å‹ï¼š{buildType} \nç”Ÿå‘½ï¼š{hp} \nå‡çº§ä»·æ ¼ï¼š{upgradePrice} \nä»·æ ¼ï¼š{price} \næ”»å‡»åŠ›ï¼š{attack} \nç”Ÿäº§é€Ÿåº¦ï¼š{productionSpeed} \nè¿è¾“é€Ÿåº¦ï¼š{waySpeed} \næè¿°ï¼š{description}";
    }
    
}
```

è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨ä»£ç ä¸­ç›´æ¥è°ƒç”¨`var isInsert = new InsertWapper<BuildData>(builbdData ).Do();` æ¥æ’å…¥æ•°æ®åº“ï¼Œä¸å¿…åœ¨å…³å¿ƒSqlè¯­å¥çš„ç¼–å†™ã€‚

ä»£ç ä¼šæ ¹æ®ä¿å­˜æ•°æ®çš„ç±»åç§°åˆ¤æ–­æ˜¯å¦æœ‰æ­¤è¡¨ï¼Œæ²¡æœ‰çš„è¯å…ˆåˆ›å»ºï¼Œå†æ’å…¥ã€‚

æœ‰æ’å…¥è¿˜æœ‰æŸ¥è¯¢ï¼Œå°è£…äº†æŸ¥è¯¢çš„æ–¹æ³•ï¼š`var buildDatas = new QueryWapper<BuildData>().Do();`

å…¶ä¸­æä¾›äº†æ¡ä»¶æŸ¥è¯¢çš„ä¸€ç³»åˆ—æ–¹æ³•å¦‚ï¼š

```jsx
public QueryWapper<T> eq(string key, object value)
{
    IsEqual();
    m_Conditions.Add(new Tuple<string, string, object>(key, "=", value));
    return this;
}
// ä¸ç­‰äº
public QueryWapper<T> ne(string key, object value)
{
    IsEqual();
    m_Conditions.Add(new Tuple<string, string, object>(key, "!=", value));
    return this;
}
// å¤§äº
public QueryWapper<T> gt(string key, object value)
{
    IsEqual();
    m_Conditions.Add(new Tuple<string, string, object>(key, ">", value));
    return this;
}
// å°äº
public QueryWapper<T> lt(string key, object value)
{
    IsEqual();
    m_Conditions.Add(new Tuple<string, string, object>(key, "<", value));
    return this;
}
// å¤§äºç­‰äº
public QueryWapper<T> ge(string key, object value)
{
    IsEqual();
    m_Conditions.Add(new Tuple<string, string, object>(key, ">=", value));
    return this;
}
// å°äºç­‰äº
public QueryWapper<T> le(string key, object value)
{
    IsEqual();
    m_Conditions.Add(new Tuple<string, string, object>(key, "<=", value));
    return this;
}
// ä¸
public QueryWapper<T> and()
{
    IsLess();
    m_Connector.Add("AND");
    return this;
}
// æˆ–
public QueryWapper<T> or()
{
    IsLess();
    m_Connector.Add("OR");
    return this;
}
// åˆ¤æ–­æ¡ä»¶ä¸è¿æ¥ç¬¦æ˜¯å¦ç­‰é•¿
private void IsEqual()
{
    **if (m_Connector.Count != m_Conditions.Count)
    {
        throw new InvalidOperationException("éœ€è¦ä½¿ç”¨è¿æ¥ç¬¦");
    }
}
// åˆ¤æ–­è¿æ¥ç¬¦æ˜¯å¦å°‘äºæ¡ä»¶
private void IsLess()
{
    if (m_Conditions.Count == m_Connector.Count)
    {
        throw new InvalidOperationException("æ•°æ®é‡ä¸è¿æ¥ç¬¦ä¸åŒ¹é…");
    }
}
```

é€šè¿‡æŸ¥è¯¢åˆ°çš„æ•°æ®ä½¿ç”¨åå°„å…¨éƒ½å­˜æ”¾åˆ°ç±»ä¸­ã€‚

### (2)åŠ¨ç”»

é€šè¿‡`MonoBehaviour` ä¸Šä¸‹æ–‡è·å–åˆ°`StartCoroutine`æ–¹æ³•ï¼Œå¯ä»¥åœ¨å·¥å…·ç±»ä¸­ä½¿ç”¨åç¨‹ï¼Œåœ¨å·¥å…·ç±»ä¸­å®šä¹‰é€šç”¨çš„æ»‘åŠ¨åŠ¨ç”»å’Œå…¶ä»–é€šç”¨åŠ¨ç”»ã€‚

### (3)UI

é€šè¿‡`UIManager` æ¥ç®¡ç†ä¸€äº›éœ€è¦å¤šæ¬¡å¤ç”¨çš„UIï¼Œå¦‚ä¿¡æ¯é¢æ¿ï¼Œå»ºç­‘é€‰æ‹©é¢æ¿ï¼Œæç¤ºä»¥åŠè­¦å‘Šã€‚

æ¯ä¸ªé€šç”¨UIéƒ½å‘å¤–æä¾›ä¿®æ”¹å†…å®¹ã€‚

### (4)éš¾åº¦å¢åŠ ï¼Œå‡çº§ç³»ç»Ÿ

æ¯æ™šè¿‡å»ï¼Œå¹½çµçš„è¡€é‡éƒ½ä¼šå¢åŠ 1.05å€ï¼Œæ‰€ä»¥åœ¨æ¸¸æˆè¿›è¡Œä¸­å¼•å…¥äº†å‡çº§ç³»ç»Ÿï¼Œç‚¹å‡»ä¸åŒçš„å»ºç­‘ï¼Œä¼šæ˜¾ç¤ºè¯¥å»ºç­‘çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©å‡çº§è¯¥ç‰©å“æˆ–è€…æ‰¹é‡å‡çº§åŒç±»ç‰©å“ã€‚